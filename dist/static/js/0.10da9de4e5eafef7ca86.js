webpackJsonp([0],{mczQ:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r.d(t,"AgoraRTCObj",function(){return m});var n=r("Xxa5"),o=r.n(n),c=r("exGp"),a=r.n(c),s=r("BK/k"),i=r("yt7g"),u="",l="",d="";navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone|Safari&&Chrome)/i)?document.body.clientWidth<480?(l=window.screen.width,d=window.screen.height/2):(l=480,d=640):(l=640,d=480);var m={home:null,scriptLoadComplete:!1,rtc:{client:null,localMedia:null,localPlayer:null,remotePlayers:[],localStreamStatus:null},loadAgoraScript:function(e){var t=this;return a()(o.a.mark(function n(){return o.a.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:r.i(i.f)("https://data.monkey.cool/web/AgoraRTC4.5.0.js",function(){t.scriptLoadComplete=!0,AgoraRTC.Logger.setLogLevel(4),e&&e()});case 1:case"end":return n.stop()}},n,t)}))()},getClient:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{mode:"rtc",codec:"vp8"};return a()(o.a.mark(function r(){return o.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(!e.rtc.client){r.next=2;break}return r.abrupt("return",e.rtc.client);case 2:return e.rtc.client=AgoraRTC.createClient(t),r.abrupt("return",e.rtc.client);case 4:case"end":return r.stop()}},r,e)}))()},getDevices:function(){var e=this;return a()(o.a.mark(function t(){return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",AgoraRTC.getDevices());case 1:case"end":return e.stop()}},t,e)}))()},checkSystemRequirements:function(){return AgoraRTC.checkSystemRequirements()},screenshot:function(e){var t=this;return a()(o.a.mark(function r(){var n;return o.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:n=t,n.home.UploadgetReportRequest(e);case 2:case"end":return r.stop()}},r,t)}))()},reportscreenshot:function(){var e=this;return a()(o.a.mark(function t(){var r,n,c,a,s,i,m;return o.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:r=e,n=document.getElementById("101").getElementsByTagName("div")[0].id,c=document.getElementById(n).getElementsByTagName("video")[0],a=l,s=d,i=document.getElementById("canvasd"),m=i.getContext("2d"),i.width=a,i.height=s,m.drawImage(c,0,0),console.log(m.getImageData(0,0,a,s)),u=m.getImageData(0,0,a,s),r.home.UploadgetReportRequest(u);case 13:case"end":return t.stop()}},t,e)}))()},initCheck:function(e,t){var r=this;return a()(o.a.mark(function t(){var n,c;return o.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,n=r.checkSystemRequirements(),console.log("checkSystemRequirements",n),!r.rtc.localMedia){t.next=7;break}return t.abrupt("return",!0);case 7:if(!n){t.next=14;break}return c=AgoraRTC.createStream({streamID:e,audio:!0,video:!0,screen:!1,facingMode:"user"}),r.rtc.localMedia=c,console.log("创建本地视频流"),t.abrupt("return",c);case 14:return console.error("浏览器不支持"),t.abrupt("return",!1);case 16:t.next=22;break;case 18:return t.prev=18,t.t0=t.catch(0),console.error("initCheck error",t.t0),t.abrupt("return",!1);case 22:case"end":return t.stop()}},t,r,[[0,18]])}))()},judgeIsHasLocalVideo:function(){return this.rtc.localStreamStatus},createLocal:function(e){var t=this;return a()(o.a.mark(function r(){var n,c;return o.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(t.home=e,!t.rtc.localMedia||!t.rtc.localPlayer){r.next=10;break}console.log("已经有本地视频"),n=t,t.rtc.localPlayer.remove(),c=document.querySelector("#anchor-video"),c.appendChild(t.rtc.localPlayer),t.rtc.localMedia.play(t.rtc.localPlayer.id,function(e){console.log("播放本地视频",e),e&&"aborted"!==e.status&&(console.error("自己的预览视频播放失败",e),n.rtc.localMedia.resume().then(function(){console.log("自己的预览视频恢复成功："+result)}).catch(function(e){console.error("自己的预览视频恢复失败："+e)}))}),r.next=21;break;case 10:return console.log("初始化本地视频===>start"),r.prev=11,r.next=14,t.getClient();case 14:t.rtc.client=r.sent,t.rtc.client.init(s.a.agoraAppid,function(){var e=a()(o.a.mark(function e(r){var n,c;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("init success"),n=document.createElement("div"),n.id="101",n.style.width="100%",n.style.height="100%",t.rtc.localPlayer=n,c=document.querySelector("#anchor-video"),c.appendChild(n),console.log("本地视频添加到dom中"),t.rtc.localMedia.init(function(){console.log("监听本地视频流"),t.rtc.localStreamStatus=!0;var e=t;t.rtc.localMedia.play(n.id,function(t){console.log("播放本地视频",t),t&&"aborted"!==t.status&&(console.error("自己的预览视频播放失败",t),e.rtc.localMedia.resume().then(function(){console.log("自己的预览视频恢复成功："+result)}).catch(function(e){console.error("自己的预览视频恢复失败："+e)}))}),t.rtc.localMedia.on("player-status-change",function(t){console.log("local video play change to state",t,this.home.connected),t.isErrorState&&"paused"===t.status&&this.home.connected&&(console.error("local Stream is paused unexpectedly. Trying to resume..."),that.rtc.localMedia.resume().then(function(){console.log("local Stream is resumed successfully")}).catch(function(t){console.error("local Failed to resume stream. Error "+t.name+" Reason "+t.message),e.rtc.localMedia.resume().then(function(){console.log("自己的预览视频恢复成功："+result)}).catch(function(e){console.error("自己的预览视频恢复失败："+e)})})),"play"!==t.status||this.home.connected||(this.home.connected=!0)}),t.rtc.client.on("stream-added",function(){var e=a()(o.a.mark(function e(r){return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("stream-added 成功"),t.home.$reportAnalyticsFun("Dug_STREAM_ADDED"),t.rtc.client.subscribe(r.stream,{video:!0,audio:!0});case 3:case"end":return e.stop()}},e,t)}));return function(t){return e.apply(this,arguments)}}()),t.rtc.client.on("stream-subscribed",function(){var e=a()(o.a.mark(function e(r){return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t.home.$reportAnalyticsFun("Dug_STREAM_SUBSCRIBED"),console.log("stream-subscribed 成功",r,t.home.connectStatus,t.home.connectingType);case 2:case"end":return e.stop()}},e,t)}));return function(t){return e.apply(this,arguments)}}()),t.rtc.client.on("first-video-frame-decode",function(){var e=a()(o.a.mark(function e(r){var n,c,a,s;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=t,console.log("first-video-frame-decode 成功",r),2===n.home.connectStatus&&4===t.home.connectingType&&(c=document.querySelector("#audience-video"),c.innerHTML="",a=r.stream,s=document.createElement("div"),s.id=r.stream.getId(),s.style.width="100%",s.style.height="100%",c.appendChild(s),t.rtc.remotePlayers.push(s),console.log("视频已添加到dom中"),n.home.didReceiveFirstRemoteVideo(r),a.play(s.id,function(e){e&&"aborted"!==e.status&&(n.home.$reportAnalyticsFun("Dug_first_video_4_1",{}),console.error("播放失败",e),a.resume().then(function(e){n.home.$reportAnalyticsFun("Dug_first_video_4_2",{}),console.log("恢复成功："+e)}).catch(function(e){console.error("恢复失败："+e),n.home.$reportAnalyticsFun("Dug_first_video_4_3",{})}))}),a.on("player-status-change",function(e){console.log("video play change to state",e.status),e.isErrorState&&"paused"===e.status&&n.home.other_connected&&(console.error("Stream is paused unexpectedly. Trying to resume..."),a.resume().then(function(){console.log("Stream is resumed successfully")}).catch(function(e){console.error("Failed to resume stream. Error "+e.name+" Reason "+e.message)})),"play"!==e.status||n.home.other_connected||(n.home.other_connected=!0,n.home.didReceiveFirstRemoteVideo(r))}));case 3:case"end":return e.stop()}},e,t)}));return function(t){return e.apply(this,arguments)}}()),t.rtc.client.on("peer-online",function(){var e=a()(o.a.mark(function e(r){return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("加入房间",r),t.home.$reportAnalyticsFun("PEER-ONLINE"),t.home.didReceiveRemoteUserJoined(r);case 3:case"end":return e.stop()}},e,t)}));return function(t){return e.apply(this,arguments)}}()),t.rtc.client.on("peer-leave",function(){var e=a()(o.a.mark(function e(r){var n,c;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("离开房间",r),r.uid&&(n=t.rtc.remotePlayers.find(function(e){return e.id===r.uid}),n&&(console.log("他人离开, 将 player从数组移除",r.uid),n.remove(),(c=t.rtc.remotePlayers.indexOf(n))>-1&&t.rtc.remotePlayers.splice(c,1)),r.stream&&(r.stream.stop(r.uid),t.rtc.client.unsubscribe(r.stream))),t.home.didReceiveRemoteUserLeave(r);case 3:case"end":return e.stop()}},e,t)}));return function(t){return e.apply(this,arguments)}}())},function(e){e&&"NotAllowedError"===e.msg&&(t.rtc.localStreamStatus=!1,t.home.StopMatch&&t.home.StopMatch(!1)),console.error("初始化本地流失败",e)});case 10:case"end":return e.stop()}},e,t)}));return function(t){return e.apply(this,arguments)}}(),function(e){console.error("本地视频初始化错误",e)}),r.next=21;break;case 18:r.prev=18,r.t0=r.catch(11),console.error("createLocal error",r.t0);case 21:case"end":return r.stop()}},r,t,[[11,18]])}))()},joinPublish:function(e){var t=this;return a()(o.a.mark(function r(){var n,c;return o.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:n=document.querySelector("#audience-video"),n&&(n.innerHTML=""),c=t,t.rtc.client.join(e.token,e.channel,e.userId,function(e){console.log("********开始推流*******",new Date),c.home.connected=!0,c.rtc.client.publish(c.rtc.localMedia,function(e){console.error("推流失败",e),e&&c.home.$reportAnalyticsFun("PUBLISH_FAIL")})},function(e){console.error("加入房间失败",e),e&&c.home.$reportAnalyticsFun("JOIN_ROOM_FAIL")});case 4:case"end":return r.stop()}},r,t)}))()},leaveCall:function(){var e=this;return a()(o.a.mark(function t(){var r;return o.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:e.rtc.remotePlayers.forEach(function(e,t){console.log("离开",e.id),e.remove()}),e.rtc.remotePlayers=[],r=document.querySelector("#audience-video"),r&&(r.innerHTML=""),e.rtc.client&&(e.home.connected=!1,e.rtc.client.leave(function(){console.log("client leaves channel success")},function(e){console.error("channel leave failed",e)}));case 5:case"end":return t.stop()}},t,e)}))()}}}});